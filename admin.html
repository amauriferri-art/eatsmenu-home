<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - EatsMenu</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary: #00e676; --bg: #050505; --surface: #121212; --border: #333; --text: #fff; }
        * { box-sizing: border-box; font-family: 'Outfit', sans-serif; margin: 0; padding: 0; outline: none; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }
        
        .dash-header { background: var(--surface); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .dash-container { max-width: 900px; margin: 0 auto; padding: 30px 20px; width: 100%; }
        
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem; font-weight: 600; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; background: #080808; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 10px; transition: 0.3s; }
        input:focus { border-color: var(--primary); }
        
        /* Checkboxes dias */
        .days-wrapper { display: flex; gap: 10px; flex-wrap: wrap; background: #080808; padding: 15px; border-radius: 10px; border: 1px solid var(--border); }
        .day-option { display: flex; align-items: center; gap: 8px; cursor: pointer; color: #fff; font-weight: 600; background: #222; padding: 8px 15px; border-radius: 20px; border: 1px solid #333; transition: 0.2s; }
        .day-option:has(input:checked) { background: rgba(0, 230, 118, 0.2); border-color: var(--primary); color: var(--primary); }
        .day-option input { display: none; } 

        /* Cores */
        .color-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .color-box { background: #222; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #333; }
        .color-box label { font-size: 0.85rem; margin-bottom: 5px; display: block; }
        input[type="color"] { width: 100%; height: 40px; border: none; padding: 0; background: none; cursor: pointer; }

        .btn { background: var(--primary); color: #000; border: none; padding: 12px 25px; border-radius: 10px; font-weight: 800; cursor: pointer; width: 100%; text-transform: uppercase; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 1px solid #555; color: #ccc; }
        .btn-outline.active { border-color: var(--primary); color: var(--primary); background: rgba(0,230,118,0.1); }
        .btn-danger { background: #ff1744; color: white; width: auto; padding: 5px 15px; font-size: 0.8rem; }

        .tabs { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; }
        .tabs button { flex: 1; white-space: nowrap; }

        .item-list { background: var(--surface); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .file-upload { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-upload input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        .file-btn { background: #222; border: 1px dashed #555; color: #aaa; padding: 10px; width: 100%; text-align: center; border-radius: 10px; cursor: pointer; }
        
        #loading { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loading"><h3>Carregando Painel...</h3></div>

    <div class="dash-header">
        <h3 style="color:var(--primary)">EatsMenu <span style="color:#fff; font-size:0.8em">Admin</span></h3>
        <button class="btn btn-danger" onclick="logout()">Sair</button>
    </div>

    <div class="dash-container">
        <div style="background:#1a1a1a; padding:20px; border-radius:15px; margin-bottom:30px; text-align:center; border:1px dashed var(--primary);">
            <p style="color:#aaa; margin-bottom:10px;">SEU CARD√ÅPIO ONLINE:</p>
            <a id="link-loja" href="#" target="_blank" style="color:var(--primary); font-weight:800; font-size:1.2rem; text-decoration:none;">...</a>
        </div>

        <div class="tabs">
            <button class="btn active" onclick="setTab('loja')" id="tab-btn-loja">üè™ Loja & Visual</button>
            <button class="btn btn-outline" onclick="setTab('produtos')" id="tab-btn-produtos">üçî Card√°pio</button>
            <button class="btn btn-outline" onclick="setTab('entregas')" id="tab-btn-entregas">üõµ Entregas & Hor√°rios</button>
        </div>

        <div id="view-loja">
            <div class="input-group"><label>Nome da Loja</label><input type="text" id="conf-nome"></div>
            <div class="input-group"><label>Link (Slug)</label><input type="text" id="conf-slug" onkeyup="limparSlug(this)"></div>
            <div class="input-group"><label>WhatsApp (Ex: 55279...)</label><input type="text" id="conf-zap"></div>
            
            <div style="background: rgba(0,230,118,0.05); padding: 15px; border-radius: 10px; border: 1px dashed var(--primary); margin-bottom: 20px;">
                <h4 style="color:var(--primary); margin-bottom: 10px;">Pagamento PIX</h4>
                <div class="input-group"><label>Chave Pix</label><input type="text" id="conf-pix-key"></div>
                <div class="input-group"><label>Nome do Benefici√°rio</label><input type="text" id="conf-pix-name"></div>
            </div>

            <div style="background: #1a1a1a; padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px;">
                <h4 style="color:var(--primary); margin-bottom: 15px;">üé® Personaliza√ß√£o Total</h4>
                <div class="color-grid">
                    <div class="color-box">
                        <label>Bot√µes (Principal)</label>
                        <input type="color" id="conf-cor" value="#00e676">
                    </div>
                    <div class="color-box">
                        <label>Fundo do Site</label>
                        <input type="color" id="conf-cor-bg" value="#121212">
                    </div>
                    <div class="color-box">
                        <label>Cart√µes/Header</label>
                        <input type="color" id="conf-cor-header" value="#1e1e1e">
                    </div>
                    <div class="color-box">
                        <label>Texto Geral</label>
                        <input type="color" id="conf-cor-text" value="#ffffff">
                    </div>
                </div>
            </div>

            <div style="background: #1a1a1a; padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px;">
                <h4 style="color:var(--primary); margin-bottom: 10px;">üñ®Ô∏è Impress√£o (NFC/PC)</h4>
                <div class="input-group"><label>Nome do PC</label><input type="text" id="conf-print-pc" placeholder="Ex: CAIXA-01"></div>
                <div class="input-group"><label>Nome da Impressora</label><input type="text" id="conf-print-name" placeholder="Ex: MP-4200"></div>
            </div>

            <div class="input-group"><label>Logo (URL)</label><input type="text" id="conf-logo"></div>
            <div class="input-group"><label>Banner (URL)</label><input type="text" id="conf-banner"></div>
            
            <button class="btn" onclick="salvarLoja()">Salvar Dados</button>
        </div>

        <div id="view-produtos" style="display:none;">
            <div style="background:var(--surface); padding:20px; border-radius:15px; margin-bottom:20px; border:1px solid #333;">
                <h4 style="margin-bottom:15px; color:var(--primary)">+ Novo Produto</h4>
                
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
                    <div class="input-group"><input type="text" id="prod-nome" placeholder="Nome"></div>
                    <div class="input-group"><input type="number" id="prod-preco" placeholder="Pre√ßo"></div>
                </div>
                
                <div class="input-group">
                    <input type="text" id="prod-cat" placeholder="Categoria (Lanches, Bebidas...)" list="list-cats">
                    <datalist id="list-cats"><option value="Lanches"><option value="Bebidas"><option value="Por√ß√µes"></datalist>
                </div>
                
                <div class="input-group"><textarea id="prod-desc" placeholder="Descri√ß√£o..." rows="2"></textarea></div>

                <div class="input-group">
                    <label>Imagem</label>
                    <div class="file-upload">
                        <div class="file-btn" id="btn-upload-text"><i class="fas fa-camera"></i> Escolher Foto ou Colar URL abaixo</div>
                        <input type="file" id="prod-file" accept="image/*" onchange="handleFileUpload(this)">
                    </div>
                    <input type="text" id="prod-img" placeholder="Ou cole a URL da imagem aqui" style="margin-top:5px;">
                    <small id="upload-status" style="color: var(--primary); display:none;">Enviando...</small>
                </div>
                
                <div style="margin-top:10px; background: #000; padding: 10px; border-radius: 8px;">
                    <label style="font-size:0.8rem; color:#aaa;">Adicionais (Ex: Bacon:3.00, Ovo:2.00)</label>
                    <input type="text" id="prod-adds" placeholder="Nome:Pre√ßo, Nome:Pre√ßo" style="border:none; border-bottom:1px solid #333;">
                </div>

                <button class="btn" onclick="addProduto()" style="margin-top:15px;">Cadastrar Produto</button>
            </div>
            <div id="lista-produtos"></div>
        </div>

        <div id="view-entregas" style="display:none;">
            <div style="background:var(--surface); padding:20px; border-radius:15px; margin-bottom:20px; border:1px solid #333;">
                <h4 style="margin-bottom:15px; color:var(--primary)">üïí Hor√°rio e Dias</h4>
                
                <label style="color:#aaa; font-size:0.9rem; margin-bottom:10px; display:block;">Dias de Funcionamento:</label>
                <div class="days-wrapper" id="days-container">
                    <label class="day-option"><input type="checkbox" value="0"> Dom</label>
                    <label class="day-option"><input type="checkbox" value="1"> Seg</label>
                    <label class="day-option"><input type="checkbox" value="2"> Ter</label>
                    <label class="day-option"><input type="checkbox" value="3"> Qua</label>
                    <label class="day-option"><input type="checkbox" value="4"> Qui</label>
                    <label class="day-option"><input type="checkbox" value="5"> Sex</label>
                    <label class="day-option"><input type="checkbox" value="6"> S√°b</label>
                </div>

                <div style="display:flex; gap:10px; margin-top:20px;">
                    <div style="flex:1"><label>Abertura (HH:MM)</label><input type="time" id="loja-abre"></div>
                    <div style="flex:1"><label>Fechamento (HH:MM)</label><input type="time" id="loja-fecha"></div>
                </div>
                <button class="btn" onclick="salvarHorario()" style="margin-top:10px;">Salvar Configura√ß√µes de Tempo</button>
            </div>

            <div style="background:var(--surface); padding:20px; border-radius:15px; margin-bottom:20px; border:1px solid #333;">
                <h4 style="margin-bottom:15px; color:var(--primary)">üõµ Taxas de Entrega</h4>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="bairro-nome" placeholder="Nome do Bairro" style="flex:2;">
                    <input type="number" id="bairro-taxa" placeholder="Valor R$" style="flex:1;">
                </div>
                <button class="btn" onclick="addBairro()" style="margin-top:10px;">Adicionar Bairro</button>
            </div>
            <div id="lista-bairros"></div>
        </div>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // CONFIGURA√á√ÉO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBIvmoayNis2C2xLFQtpRzzrc4dWxGvotU",
            authDomain: "eatsmenu-62cfa.firebaseapp.com",
            projectId: "eatsmenu-62cfa",
            storageBucket: "eatsmenu-62cfa.firebasestorage.app",
            messagingSenderId: "896131512194",
            appId: "1:896131512194:web:51891cf2bd5a04c6c7819b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let userUid = null;
        let data = { produtos: [], bairros: [], dias_func: [] };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userUid = user.uid;
                await loadData();
                document.getElementById('loading').style.display = 'none';
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadData() {
            const snap = await getDoc(doc(db, "lojas", userUid));
            if (snap.exists()) {
                data = snap.data();
                if(!data.produtos) data.produtos = [];
                if(!data.bairros) data.bairros = [];
                if(!data.dias_func) data.dias_func = [0,1,2,3,4,5,6];
                
                // Preenche campos
                const campos = ['conf-nome','conf-slug','conf-zap','conf-pix-key','conf-pix-name',
                                'conf-logo','conf-banner','conf-cor','conf-cor-bg','conf-cor-header','conf-cor-text',
                                'conf-print-pc','conf-print-name'];
                
                campos.forEach(id => {
                    const key = id.replace('conf-','').replace(/-/g,'_');
                    if(document.getElementById(id)) document.getElementById(id).value = data[key] || "";
                });
                
                // Hor√°rios
                document.getElementById('loja-abre').value = data.hora_abre || "18:00";
                document.getElementById('loja-fecha').value = data.hora_fecha || "23:00";
                
                // Dias
                document.querySelectorAll('#days-container input').forEach(chk => {
                    chk.checked = data.dias_func.includes(parseInt(chk.value));
                });

                updateLink(data.slug);
                renderProdutos();
                renderBairros();
            }
        }

        window.handleFileUpload = async (input) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                document.getElementById('upload-status').style.display = 'block';
                try {
                    const storageRef = ref(storage, `imagens/${userUid}/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);
                    document.getElementById('prod-img').value = url;
                    document.getElementById('upload-status').innerText = "Sucesso!";
                    document.getElementById('upload-status').style.color = "#00e676";
                } catch (error) {
                    console.error(error);
                    document.getElementById('upload-status').innerText = "Erro no envio.";
                }
            }
        };

        window.salvarLoja = async () => {
            const update = {
                nome: document.getElementById('conf-nome').value,
                slug: document.getElementById('conf-slug').value,
                whatsapp: document.getElementById('conf-zap').value,
                pix_key: document.getElementById('conf-pix-key').value,
                pix_name: document.getElementById('conf-pix-name').value,
                print_pc: document.getElementById('conf-print-pc').value,
                print_name: document.getElementById('conf-print-name').value,
                logo: document.getElementById('conf-logo').value,
                banner: document.getElementById('conf-banner').value,
                cor: document.getElementById('conf-cor').value,
                cor_bg: document.getElementById('conf-cor-bg').value,
                cor_header: document.getElementById('conf-cor-header').value,
                cor_text: document.getElementById('conf-cor-text').value
            };
            await updateDoc(doc(db, "lojas", userUid), update);
            updateLink(update.slug);
            toast("Dados Salvos!");
        };

        window.salvarHorario = async () => {
            const diasSelecionados = [];
            document.querySelectorAll('#days-container input:checked').forEach(chk => {
                diasSelecionados.push(parseInt(chk.value));
            });

            await updateDoc(doc(db, "lojas", userUid), {
                hora_abre: document.getElementById('loja-abre').value,
                hora_fecha: document.getElementById('loja-fecha').value,
                dias_func: diasSelecionados
            });
            toast("Hor√°rio e Dias Atualizados!");
        };

        window.addProduto = async () => {
            const prod = {
                nome: document.getElementById('prod-nome').value,
                preco: parseFloat(document.getElementById('prod-preco').value),
                cat: document.getElementById('prod-cat').value,
                desc: document.getElementById('prod-desc').value,
                img: document.getElementById('prod-img').value,
                adds: document.getElementById('prod-adds').value
            };
            if(!prod.nome || !prod.preco) return toast("Preencha nome e pre√ßo", "error");
            data.produtos.push(prod);
            await updateDoc(doc(db, "lojas", userUid), { produtos: data.produtos });
            
            document.getElementById('prod-nome').value = "";
            document.getElementById('prod-preco').value = "";
            document.getElementById('prod-img').value = "";
            
            renderProdutos();
            toast("Produto Adicionado!");
        };

        window.addBairro = async () => {
            const nome = document.getElementById('bairro-nome').value;
            const taxa = parseFloat(document.getElementById('bairro-taxa').value);
            if(!nome) return toast("Preencha o nome", "error");
            data.bairros.push({ nome, taxa: taxa || 0 });
            await updateDoc(doc(db, "lojas", userUid), { bairros: data.bairros });
            document.getElementById('bairro-nome').value = "";
            renderBairros();
            toast("Bairro Adicionado!");
        };

        function renderProdutos() {
            const div = document.getElementById('lista-produtos');
            div.innerHTML = "";
            data.produtos.forEach((p, idx) => {
                div.innerHTML += `<div class="item-list"><div><strong>${p.nome}</strong><br><small>R$ ${p.preco}</small></div><button class="btn-danger" style="border:none;padding:5px 10px;border-radius:5px;cursor:pointer;" onclick="delItem('produtos', ${idx})">Excluir</button></div>`;
            });
        }

        function renderBairros() {
            const div = document.getElementById('lista-bairros');
            div.innerHTML = "";
            data.bairros.forEach((b, idx) => {
                div.innerHTML += `<div class="item-list"><div>${b.nome} - R$ ${b.taxa}</div><button class="btn-danger" style="border:none;padding:5px 10px;border-radius:5px;cursor:pointer;" onclick="delItem('bairros', ${idx})">Excluir</button></div>`;
            });
        }

        window.delItem = async (tipo, idx) => {
            if(confirm("Excluir?")) {
                data[tipo].splice(idx, 1);
                await updateDoc(doc(db, "lojas", userUid), { [tipo]: data[tipo] });
                tipo === 'produtos' ? renderProdutos() : renderBairros();
            }
        };

        function updateLink(slug) {
            const url = `https://${slug}.eatsmenu.com.br`;
            document.getElementById('link-loja').href = url;
            document.getElementById('link-loja').innerText = url;
        }
        window.setTab = (tab) => {
            ['loja', 'produtos', 'entregas'].forEach(t => {
                document.getElementById('view-'+t).style.display = t === tab ? 'block' : 'none';
                document.getElementById('tab-btn-'+t).className = t === tab ? 'btn active' : 'btn btn-outline';
            });
        }
        window.limparSlug = (el) => el.value = el.value.toLowerCase().replace(/[^a-z0-9-]/g, '');
        window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
        function toast(msg, type="success") { Toastify({ text: msg, style: { background: type==="success"?"#00e676":"#ff1744" } }).showToast(); }
    </script>
</body>
</html>
