<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carregando...</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <style>
        :root { 
            --primary: #00e676; 
            --bg: #121212; 
            --surface: #1e1e1e; 
            --text: #fff; 
            --border: #333; 
            --danger: #ff1744;
        }
        
        body.light-mode { --bg: #f4f4f4; --surface: #fff; --text: #1a1a1a; --border: #ddd; }
        
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; outline:none; -webkit-tap-highlight-color:transparent; }
        body { background:var(--bg); color:var(--text); padding-bottom:100px; transition:background 0.3s; }
        .hidden { display:none!important; }

        /* Loader */
        #loading-screen { position:fixed; inset:0; background:#000; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .spinner { width:50px; height:50px; border:5px solid #333; border-top:5px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

        /* Header */
        .header { background:var(--surface); padding-bottom:20px; border-radius:0 0 30px 30px; border-bottom:2px solid var(--primary); position:relative; overflow:hidden; }
        .banner { height:160px; background-size:cover; background-position:center; position:relative; }
        .banner::after { content:''; position:absolute; inset:0; background:linear-gradient(to bottom, transparent, rgba(0,0,0,0.9)); }
        .info { text-align:center; margin-top:-60px; position:relative; z-index:2; padding:0 20px; }
        .logo { width:110px; height:110px; border-radius:50%; border:4px solid var(--surface); background:#000; object-fit:cover; }
        .status { display:inline-block; padding:5px 15px; border-radius:20px; border:1px solid var(--primary); color:var(--primary); font-weight:bold; font-size:0.8rem; margin-top:10px; text-transform:uppercase; }
        .status.closed { border-color:red; color:red; }

        .theme-btn { position:absolute; top:20px; right:20px; width:40px; height:40px; background:rgba(0,0,0,0.6); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; cursor:pointer; z-index:10; }

        /* Cat & Prod */
        .cat-bar { position:sticky; top:0; z-index:90; background:var(--bg); padding:15px 20px; display:flex; gap:10px; overflow-x:auto; border-bottom:1px solid var(--border); backdrop-filter:blur(10px); }
        .cat-item { padding:8px 20px; border-radius:50px; background:var(--surface); border:1px solid var(--border); white-space:nowrap; cursor:pointer; transition:0.3s; color:#aaa; font-weight:600; }
        .cat-item.active { background:var(--primary); color:#000; border-color:var(--primary); font-weight:bold; }

        .container { max-width:600px; margin:0 auto; padding:20px; }
        .sec-title { font-size:1.4rem; font-weight:800; margin:30px 0 15px; border-left:5px solid var(--primary); padding-left:10px; }
        .card { background:var(--surface); padding:15px; border-radius:15px; margin-bottom:15px; display:flex; gap:15px; border:1px solid var(--border); cursor:pointer; position:relative; overflow:hidden; transition:0.2s; }
        .card:active { transform:scale(0.98); border-color:var(--primary); }
        .card-info { flex:1; }
        .card-img { width:90px; height:90px; border-radius:12px; background-size:cover; background-position:center; background-color:#333; flex-shrink:0; }

        /* Modal */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; display:none; align-items:flex-end; justify-content:center; }
        .modal.open { display:flex; animation:slideUp 0.3s; }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        .modal-body { background:var(--surface); width:100%; max-width:600px; border-radius:25px 25px 0 0; padding:25px; max-height:90vh; overflow-y:auto; border-top:2px solid var(--primary); }

        /* Cart */
        .cart-float { position:fixed; bottom:20px; left:20px; right:20px; max-width:500px; margin:0 auto; background:#111; color:var(--primary); border:2px solid var(--primary); padding:15px 25px; border-radius:50px; display:none; justify-content:space-between; align-items:center; font-weight:800; cursor:pointer; box-shadow:0 5px 20px rgba(0,230,118,0.3); z-index:95; }
        
        .form-input { width:100%; padding:12px; background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:8px; margin-bottom:10px; }
        .btn-main { width:100%; padding:15px; background:var(--primary); color:#000; font-weight:800; border:none; border-radius:12px; cursor:pointer; font-size:1.1rem; margin-top:20px; display:flex; align-items:center; justify-content:center; gap:10px; }
        
        /* Toggles */
        .toggle-group { display:flex; background:var(--bg); padding:5px; border-radius:12px; border:1px solid var(--border); margin-bottom:15px; }
        .toggle-opt { flex:1; padding:10px; text-align:center; border-radius:8px; cursor:pointer; font-weight:600; color:#aaa; }
        .toggle-opt.active { background:var(--surface); color:var(--primary); border:1px solid var(--primary); }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#fff;" id="loading-msg">Carregando Loja...</p>
    </div>

    <div class="header">
        <div class="theme-btn" onclick="toggleTheme()"><i class="fas fa-adjust"></i></div>
        <div class="banner" id="banner-img"></div>
        <div class="info">
            <img src="" class="logo" id="logo-img">
            <h1 style="margin:10px 0 5px; font-size:1.5rem; text-transform:uppercase;" id="nome-loja">...</h1>
            <div id="status" class="status">VERIFICANDO...</div>
        </div>
        <div style="padding:0 20px; margin-top:15px;">
            <input type="text" class="form-input" placeholder="üîç O que deseja pedir?" onkeyup="filtrar(this.value)">
        </div>
    </div>

    <div class="cat-bar" id="cat-list"></div>
    <div class="container" id="prod-list"></div>

    <div class="cart-float" id="btn-sacola" onclick="abrirModal('modal-carrinho')">
        <div style="display:flex; align-items:center; gap:10px;"><i class="fas fa-shopping-bag"></i> <span id="cart-count">0</span></div>
        <span id="cart-total-float">R$ 0,00</span>
    </div>

    <div class="modal" id="modal-prod">
        <div class="modal-body">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2 id="md-title">...</h2>
                <span onclick="fecharModal('modal-prod')" style="font-size:1.5rem; cursor:pointer">√ó</span>
            </div>
            <p id="md-desc" style="color:#aaa; margin-bottom:15px;">...</p>
            <h2 id="md-price" style="color:var(--primary); margin-bottom:20px;">R$ 0,00</h2>

            <div id="area-adds" class="hidden" style="margin-bottom:20px;">
                <label style="font-weight:bold; display:block; margin-bottom:10px;">Adicionais:</label>
                <div id="lista-adds"></div>
            </div>

            <textarea id="md-obs" class="form-input" rows="2" placeholder="Observa√ß√µes (Ex: Sem cebola)"></textarea>

            <div style="display:flex; gap:10px; align-items:center;">
                <button onclick="mudaQtd(-1)" style="padding:10px 15px; font-weight:bold; background:var(--bg); border:none; color:var(--text); border-radius:10px;">-</button>
                <span id="md-qtd" style="font-weight:bold; font-size:1.2rem; min-width:30px; text-align:center;">1</span>
                <button onclick="mudaQtd(1)" style="padding:10px 15px; font-weight:bold; background:var(--bg); border:none; color:var(--text); border-radius:10px;">+</button>
                <button class="btn-main" onclick="addCart()" style="margin-top:0; flex:1;">ADICIONAR</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-carrinho">
        <div class="modal-body">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3>Sua Sacola</h3>
                <span onclick="fecharModal('modal-carrinho')" style="font-size:1.5rem; cursor:pointer">√ó</span>
            </div>
            <div id="lista-carrinho" style="margin-bottom:20px; max-height:50vh; overflow-y:auto;"></div>
            <div style="display:flex; justify-content:space-between; font-size:1.3rem; font-weight:800; border-top:1px dashed var(--border); padding-top:15px;">
                <span>Total:</span> <span id="subtotal-carrinho">R$ 0,00</span>
            </div>
            <button class="btn-main" onclick="irCheckout()">FECHAR PEDIDO</button>
        </div>
    </div>

    <div class="modal" id="modal-checkout">
        <div class="modal-body">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3>Finalizar</h3>
                <span onclick="fecharModal('modal-checkout')" style="font-size:1.5rem; cursor:pointer">√ó</span>
            </div>

            <label>Seus Dados:</label>
            <input id="cli-nome" class="form-input" placeholder="Seu Nome">
            <input id="cli-tel" type="tel" class="form-input" placeholder="WhatsApp (DDD+Num)">

            <label>Entrega:</label>
            <div class="toggle-group">
                <div class="toggle-opt active" id="btn-retirada" onclick="mudarEntrega('retirada')">Retirada</div>
                <div class="toggle-opt" id="btn-entrega" onclick="mudarEntrega('entrega')">Entrega</div>
            </div>

            <div id="area-end" class="hidden">
                <div class="form-group">
                    <label>Bairro:</label>
                    <select id="cli-bairro" class="form-input" onchange="calcTotal()"><option value="-1">Selecione...</option></select>
                </div>
                
                <div class="toggle-group">
                    <div class="toggle-opt active" id="btn-manual" onclick="modoEnd('manual')">Digitar</div>
                    <div class="toggle-opt" id="btn-gps" onclick="modoEnd('gps')">Usar GPS</div>
                </div>

                <div id="form-manual">
                    <div style="display:flex; gap:10px;">
                        <input id="cli-rua" class="form-input" placeholder="Rua" style="flex:2">
                        <input id="cli-num" class="form-input" placeholder="N¬∫" style="flex:1">
                    </div>
                    <input id="cli-ref" class="form-input" placeholder="Refer√™ncia">
                </div>
                
                <div id="form-gps" class="hidden" style="text-align:center;">
                    <button onclick="pegarGPS()" style="background:#2196F3; color:#fff; border:none; padding:10px 20px; border-radius:10px; cursor:pointer;">üìç Pegar Localiza√ß√£o</button>
                    <p id="gps-msg" style="color:var(--primary); display:none; margin-top:5px;">Localiza√ß√£o Salva!</p>
                </div>
            </div>

            <label>Pagamento:</label>
            <select id="cli-pag" class="form-input" onchange="checkPag()">
                <option>Cart√£o</option><option>Pix</option><option>Dinheiro</option>
            </select>

            <div id="box-pix" class="hidden" style="background:rgba(0,230,118,0.1); padding:10px; border-radius:10px; border:1px dashed var(--primary); margin-bottom:10px;">
                <p>Chave: <strong id="pix-key">...</strong></p>
                <p>Nome: <strong id="pix-nome">...</strong></p>
                <small style="color:orange">‚ö†Ô∏è Envie o comprovante no Zap!</small>
            </div>
            
            <div id="box-troco" class="hidden">
                <input id="cli-troco" class="form-input" placeholder="Troco para quanto?">
            </div>

            <div style="border-top:1px dashed var(--border); padding-top:15px; margin-top:15px;">
                <div style="display:flex; justify-content:space-between;"><span>Subtotal:</span> <span id="resumo-sub">R$ 0,00</span></div>
                <div id="resumo-taxa-row" style="display:flex; justify-content:space-between; color:var(--danger);" class="hidden"><span>Entrega:</span> <span id="resumo-taxa">+ R$ 0,00</span></div>
                <div style="display:flex; justify-content:space-between; font-size:1.3rem; font-weight:800; color:var(--primary); margin-top:10px;"><span>Total:</span> <span id="resumo-total">R$ 0,00</span></div>
            </div>

            <button class="btn-main" style="background:#25D366; color:#fff;" onclick="enviarZap()">
                <i class="fab fa-whatsapp"></i> ENVIAR PEDIDO
            </button>
        </div>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIvmoayNis2C2xLFQtpRzzrc4dWxGvotU",
            authDomain: "eatsmenu-62cfa.firebaseapp.com",
            projectId: "eatsmenu-62cfa",
            storageBucket: "eatsmenu-62cfa.firebasestorage.app",
            messagingSenderId: "896131512194",
            appId: "1:896131512194:web:51891cf2bd5a04c6c7819b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let loja = null, cart = [], curr = null, qtd = 1, gpsLoc = "", entregaTipo = 'retirada', modoEndAtual = 'manual';

        // START
        (async function init() {
            try {
                const params = new URLSearchParams(window.location.search);
                const slug = params.get('loja');
                if(!slug) throw new Error("Loja n√£o especificada na URL.");

                const q = query(collection(db, "lojas"), where("slug", "==", slug));
                const snap = await getDocs(q);
                
                if(snap.empty) throw new Error("Loja n√£o encontrada.");
                
                loja = snap.docs[0].data();
                renderLoja();
                carregarUser(); // Puxa dados salvos
                document.getElementById('loading-screen').style.display = 'none';
            } catch (e) {
                document.getElementById('loading-msg').innerText = e.message;
                document.getElementById('loading-msg').style.color = "#ff1744";
            }
        })();

        function renderLoja() {
            document.title = loja.nome;
            const root = document.documentElement;
            if(loja.cor) root.style.setProperty('--primary', loja.cor);
            if(loja.cor_bg) root.style.setProperty('--bg', loja.cor_bg);
            if(loja.cor_header) root.style.setProperty('--surface', loja.cor_header);
            if(loja.cor_text) root.style.setProperty('--text', loja.cor_text);

            document.getElementById('nome-loja').innerText = loja.nome;
            if(loja.logo) document.getElementById('logo-img').src = loja.logo;
            if(loja.banner) document.getElementById('banner-img').style.backgroundImage = `url('${loja.banner}')`;
            if(loja.pix_key) {
                document.getElementById('pix-key').innerText = loja.pix_key;
                document.getElementById('pix-nome').innerText = loja.pix_name || "";
            }

            checkHorario();

            const cats = [...new Set((loja.produtos||[]).map(p=>p.cat))];
            document.getElementById('cat-list').innerHTML = cats.map((c, i) => 
                `<div class="cat-item ${i===0?'active':''}" onclick="scrollCat('${c}', this)">${c}</div>`
            ).join('');
            
            renderProds(loja.produtos);

            const sel = document.getElementById('cli-bairro');
            (loja.bairros||[]).forEach((b,i) => sel.innerHTML += `<option value="${i}">${b.nome} (+ R$ ${b.taxa.toFixed(2)})</option>`);
        }

        window.renderProds = (lista) => {
            const div = document.getElementById('prod-list');
            div.innerHTML = "";
            const cats = [...new Set(lista.map(p=>p.cat))];
            cats.forEach(c => {
                div.innerHTML += `<div id="cat-${c}" class="sec-title">${c}</div>`;
                lista.filter(p=>p.cat===c).forEach(p => {
                    const data = encodeURIComponent(JSON.stringify(p));
                    const img = p.img ? `<div class="card-img" style="background-image:url('${p.img}')"></div>` : `<div class="card-img" style="background:#333"></div>`;
                    div.innerHTML += `
                    <div class="card" onclick="openProd('${data}')">
                        <div class="card-info">
                            <div style="font-weight:bold; font-size:1.1rem">${p.nome}</div>
                            <p style="font-size:0.8rem; color:#aaa; margin:5px 0">${p.desc||''}</p>
                            <div style="color:var(--primary); font-weight:bold">R$ ${p.preco.toFixed(2)}</div>
                        </div>
                        ${img}
                    </div>`;
                });
            });
        }

        // --- CHECKOUT LOGIC ---
        window.openProd = (data) => {
            curr = JSON.parse(decodeURIComponent(data));
            qtd = 1;
            document.getElementById('md-title').innerText = curr.nome;
            document.getElementById('md-desc').innerText = curr.desc||'';
            document.getElementById('md-price').innerText = `R$ ${curr.preco.toFixed(2)}`;
            document.getElementById('md-qtd').innerText = 1;
            document.getElementById('md-obs').value = '';
            
            const list = document.getElementById('lista-adds');
            list.innerHTML = "";
            if(curr.adds) {
                document.getElementById('area-adds').classList.remove('hidden');
                curr.adds.split(',').forEach(a => {
                    const [n, p] = a.split(':');
                    if(n&&p) list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; background:var(--bg); margin-bottom:5px; border-radius:5px;"><span>${n} (+ R$${p})</span><input type="checkbox" class="add-chk" value="${p}" data-name="${n}" style="width:20px; height:20px; accent-color:var(--primary)"></div>`;
                });
            } else {
                document.getElementById('area-adds').classList.add('hidden');
            }
            abrirModal('modal-prod');
        }

        window.addCart = () => {
            let addT = 0, addN = [];
            document.querySelectorAll('.add-chk:checked').forEach(c => {
                addT += parseFloat(c.value);
                addN.push(c.getAttribute('data-name'));
            });
            cart.push({ ...curr, qtd, obs:document.getElementById('md-obs').value, addNames:addN, total: (curr.preco+addT)*qtd });
            fecharModal('modal-prod');
            updateUI();
            Toastify({text:"Adicionado!", style:{background:"var(--primary)", color:"#000"}}).showToast();
        }

        function updateUI() {
            const count = cart.reduce((a,b)=>a+b.qtd,0);
            const total = cart.reduce((a,b)=>a+b.total,0);
            
            if(count>0) {
                document.getElementById('btn-sacola').style.display='flex';
                document.getElementById('cart-count').innerText = count;
                document.getElementById('cart-total-float').innerText = `R$ ${total.toFixed(2)}`;
            } else {
                document.getElementById('btn-sacola').style.display='none';
                fecharModal('modal-carrinho');
                fecharModal('modal-checkout');
            }

            const list = document.getElementById('lista-carrinho');
            list.innerHTML = "";
            cart.forEach((i, idx) => {
                list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px dashed #333;"><div><b>${i.qtd}x ${i.nome}</b><br><small>${i.addNames.join(', ')}</small></div><div>R$ ${i.total.toFixed(2)} <i class="fas fa-trash" style="color:red; margin-left:10px; cursor:pointer;" onclick="rmCart(${idx})"></i></div></div>`;
            });
            document.getElementById('subtotal-carrinho').innerText = `R$ ${total.toFixed(2)}`;
        }

        window.calcTotal = () => {
            const sub = cart.reduce((a,b)=>a+b.total,0);
            let taxa = 0;
            if(entregaTipo === 'entrega') {
                document.getElementById('resumo-taxa-row').classList.remove('hidden');
                const idx = document.getElementById('cli-bairro').value;
                if(idx!=-1) taxa = loja.bairros[idx].taxa;
                document.getElementById('resumo-taxa').innerText = `+ R$ ${taxa.toFixed(2)}`;
            } else document.getElementById('resumo-taxa-row').classList.add('hidden');
            
            document.getElementById('resumo-sub').innerText = `R$ ${sub.toFixed(2)}`;
            document.getElementById('resumo-total-final').innerText = `R$ ${(sub+taxa).toFixed(2)}`;
            return {sub, taxa, total: sub+taxa};
        }

        window.mudarEntrega = (t) => {
            entregaTipo = t;
            document.getElementById('btn-retirada').className = `toggle-opt ${t==='retirada'?'active':''}`;
            document.getElementById('btn-entrega').className = `toggle-opt ${t==='entrega'?'active':''}`;
            document.getElementById('area-end').classList.toggle('hidden', t!=='entrega');
            calcTotal();
        }

        window.modoEnd = (m) => {
            modoEndAtual = m;
            document.getElementById('btn-manual').className = `toggle-opt ${m==='manual'?'active':''}`;
            document.getElementById('btn-gps').className = `toggle-opt ${m==='gps'?'active':''}`;
            document.getElementById('form-manual').classList.toggle('hidden', m!=='manual');
            document.getElementById('form-gps').classList.toggle('hidden', m!=='gps');
        }

        window.checkPag = () => {
            const p = document.getElementById('cli-pag').value;
            document.getElementById('box-pix').classList.toggle('hidden', p!=='Pix');
            document.getElementById('box-troco').classList.toggle('hidden', p!=='Dinheiro');
        }

        window.enviarZap = () => {
            if(!checkHorario()) { notify("Loja Fechada!", "error"); return; }
            const nome = document.getElementById('cli-nome').value;
            const tel = document.getElementById('cli-tel').value;
            
            if(!nome || !tel) return notify("Preencha Nome e Zap", "error");
            if(entregaTipo==='entrega' && document.getElementById('cli-bairro').value == -1) return notify("Escolha o Bairro", "error");

            salvarUser(); // Salva no navegador
            const vals = calcTotal();

            let msg = `*NOVO PEDIDO - ${loja.nome}* üöÄ\n\n*Cliente:* ${nome}\n*Zap:* ${tel}\n*Tipo:* ${entregaTipo.toUpperCase()}\n`;
            
            if(entregaTipo==='entrega') {
                const bIdx = document.getElementById('cli-bairro').value;
                msg += `*Bairro:* ${loja.bairros[bIdx].nome}\n`;
                if(modoEndAtual==='manual') {
                    msg += `*End:* ${document.getElementById('cli-rua').value}, ${document.getElementById('cli-num').value}\nRef: ${document.getElementById('cli-ref').value}\n`;
                } else {
                    if(!gpsLoc) return notify("Pegue a localiza√ß√£o GPS!", "error");
                    msg += `*GPS:* ${gpsLoc}\n`;
                }
            }

            msg += `\n*ITENS:*\n`;
            cart.forEach(i => {
                msg += `${i.qtd}x ${i.nome} - R$ ${i.total.toFixed(2)}\n`;
                if(i.addNames.length) msg += `  + ${i.addNames.join(', ')}\n`;
                if(i.obs) msg += `  Obs: ${i.obs}\n`;
            });

            msg += `\nSubtotal: R$ ${vals.sub.toFixed(2)}\n`;
            if(vals.taxa>0) msg += `Taxa: R$ ${vals.taxa.toFixed(2)}\n`;
            msg += `*TOTAL: R$ ${vals.total.toFixed(2)}*\n\n`;
            
            const pag = document.getElementById('cli-pag').value;
            msg += `*Pagamento:* ${pag}`;
            if(pag==='Dinheiro') msg += ` (Troco para: ${document.getElementById('cli-troco').value})`;

            if(loja.print_pc) msg += `\n\n--- IMPRESS√ÉO ---\nPC: ${loja.print_pc}\nPRINTER: ${loja.print_name}`;

            window.open(`https://wa.me/${loja.whatsapp}?text=${encodeURIComponent(msg)}`, '_blank');
            cart = []; updateUI();
        }

        // --- UTILS ---
        function salvarUser() {
            const u = { nome: document.getElementById('cli-nome').value, tel: document.getElementById('cli-tel').value, rua: document.getElementById('cli-rua').value, num: document.getElementById('cli-num').value, ref: document.getElementById('cli-ref').value };
            localStorage.setItem('eats_user', JSON.stringify(u));
        }
        function carregarUser() {
            const u = JSON.parse(localStorage.getItem('eats_user'));
            if(u) {
                document.getElementById('cli-nome').value = u.nome;
                document.getElementById('cli-tel').value = u.tel;
                document.getElementById('cli-rua').value = u.rua;
                document.getElementById('cli-num').value = u.num;
                document.getElementById('cli-ref').value = u.ref;
            }
        }

        window.pegarGPS = () => navigator.geolocation.getCurrentPosition(p => {
            gpsLoc = `http://maps.google.com/?q=${p.coords.latitude},${p.coords.longitude}`;
            document.getElementById('gps-msg').style.display='block';
            notify("Localiza√ß√£o Salva!");
        });

        function checkHorario() {
            const now = new Date();
            const dia = now.getDay();
            const hora = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
            const diasFunc = loja.dias_func || [0,1,2,3,4,5,6];
            const abre = loja.hora_abre || "00:00";
            const fecha = loja.hora_fecha || "23:59";

            let aberto = diasFunc.includes(dia);
            if(aberto) {
                if(fecha < abre) aberto = (hora >= abre || hora <= fecha); // Madrugada
                else aberto = (hora >= abre && hora <= fecha);
            }

            const st = document.getElementById('status');
            if(aberto) { st.innerText = "ABERTO"; st.classList.remove('closed'); return true; }
            else { st.innerText = "FECHADO"; st.classList.add('closed'); document.getElementById('prod-list').style.opacity='0.5'; return false; }
        }

        window.rmCart = (i) => { cart.splice(i,1); updateUI(); }
        window.irCheckout = () => { fecharModal('modal-carrinho'); abrirModal('modal-checkout'); calcTotal(); }
        window.abrirModal = (id) => document.getElementById(id).classList.add('open');
        window.fecharModal = (id) => document.getElementById(id).classList.remove('open');
        window.mudaQtd = (v) => { if(qtd+v>=1) qtd+=v; document.getElementById('md-qtd').innerText = qtd; }
        window.filtrar = (v) => renderProds(loja.produtos.filter(p=>p.nome.toLowerCase().includes(v.toLowerCase())));
        window.scrollCat = (c, el) => {
            document.querySelectorAll('.cat-item').forEach(i=>i.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('cat-'+c).scrollIntoView({behavior:'smooth', block:'center'});
        }
        window.toggleTheme = () => document.body.classList.toggle('light-mode');
        function notify(msg, type='success') { Toastify({text:msg, style:{background:type==='success'?"var(--primary)":"#ff1744", color:"#000"}}).showToast(); }
    </script>
</body>
</html>
